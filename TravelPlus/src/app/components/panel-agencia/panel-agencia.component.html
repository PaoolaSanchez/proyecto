<div class="panel-agencia">
  <!-- PANEL PRINCIPAL (solo se muestra si estÃ¡ logueado, si no redirige a login) -->
  <div *ngIf="loggedIn" class="dashboard">
    
    <!-- NotificaciÃ³n de nuevas reservas -->
    <div *ngIf="mostrarNotificacion" class="notificacion-nueva-reserva" (click)="verNuevasReservas()">
      <span class="notificacion-icono">ğŸ””</span>
      <span class="notificacion-texto">
        Â¡{{ nuevasReservas }} nueva{{ nuevasReservas > 1 ? 's' : '' }} reserva{{ nuevasReservas > 1 ? 's' : '' }}!
      </span>
      <span class="notificacion-accion">Ver ahora â†’</span>
    </div>
    
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <div class="header-left">
          <button (click)="irInicio()" class="btn-back-home">
            â† Inicio
          </button>
          <div>
            <h1>{{ agencia?.nombre }}</h1>
            <p class="subtitle">Panel de AdministraciÃ³n <span class="realtime-badge">ğŸ”´ En vivo</span></p>
          </div>
        </div>
        <button (click)="logout()" class="btn-secondary">
          ğŸšª Cerrar SesiÃ³n
        </button>
      </div>
    </header>

    <!-- NavegaciÃ³n del Panel -->
    <nav class="panel-nav">
      <button 
        [class.active]="vistaActual === 'paquetes'" 
        (click)="cambiarVista('paquetes')">
        ğŸ“¦ Mis Paquetes
      </button>
      <button 
        [class.active]="vistaActual === 'reservas'" 
        (click)="verNuevasReservas()">
        ğŸ“‹ Reservaciones
        <span *ngIf="reservasPendientes > 0" class="badge-count">{{ reservasPendientes }}</span>
        <span *ngIf="nuevasReservas > 0" class="badge-new">{{ nuevasReservas }} nueva{{ nuevasReservas > 1 ? 's' : '' }}</span>
      </button>
    </nav>

    <!-- Contenido -->
    <div class="dashboard-content">
      
      <!-- ============ SECCIÃ“N RESERVAS ============ -->
      <div class="reservas-section" *ngIf="vistaActual === 'reservas' && !mostrarFormulario">
        <div class="section-header">
          <h2>ğŸ“‹ Reservaciones de Clientes</h2>
          <div class="stats-mini">
            <span class="stat-pendiente">ğŸ• {{ reservasPendientes }} pendientes</span>
            <span class="stat-confirmada">âœ… {{ reservasConfirmadas }} confirmadas</span>
          </div>
        </div>

        <!-- Filtro de estado -->
        <div class="filtros">
          <select [(ngModel)]="filtroEstado" class="select-filtro">
            <option value="">ğŸ“Š Todos los estados</option>
            <option value="pendiente">ğŸ• Pendientes</option>
            <option value="confirmada">âœ… Confirmadas</option>
            <option value="completada">ğŸ‰ Completadas</option>
            <option value="cancelada">âŒ Canceladas</option>
          </select>
        </div>

        <!-- Lista de Reservas -->
        <div class="reservas-grid">
          <div *ngFor="let reserva of reservasFiltradas" class="reserva-card">
            <div class="reserva-header">
              <span class="reserva-estado" [ngClass]="getEstadoClase(reserva.estado)">
                {{ reserva.estado | titlecase }}
              </span>
              <span class="reserva-fecha">{{ formatearFecha(reserva.created_at) }}</span>
            </div>
            
            <h3 class="reserva-paquete">{{ reserva.paquete_nombre }}</h3>
            
            <div class="reserva-cliente">
              <div class="cliente-avatar">{{ reserva.nombre_cliente.charAt(0) }}</div>
              <div class="cliente-info">
                <strong>{{ reserva.nombre_cliente }}</strong>
                <span>{{ reserva.email_cliente }}</span>
                <span *ngIf="reserva.telefono_cliente">ğŸ“ {{ reserva.telefono_cliente }}</span>
              </div>
            </div>
            
            <div class="reserva-detalles">
              <div class="detalle-item">
                <span class="detalle-label">ğŸ‘¥ Personas:</span>
                <span>{{ reserva.num_personas }}</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">ğŸ“… Salida:</span>
                <span>{{ formatearFecha(reserva.fecha_salida) }}</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">ğŸ’° Total:</span>
                <span class="precio-total">${{ reserva.precio_total | number }} MXN</span>
              </div>
            </div>
            
            <div *ngIf="reserva.notas" class="reserva-notas">
              <strong>ğŸ“ Notas:</strong> {{ reserva.notas }}
            </div>
            
            <div class="reserva-acciones">
              <button *ngIf="reserva.estado === 'pendiente'" 
                      class="btn-confirmar"
                      (click)="actualizarEstadoReserva(reserva.id, 'confirmada')">
                âœ… Confirmar
              </button>
              <button *ngIf="reserva.estado === 'confirmada'" 
                      class="btn-completar"
                      (click)="actualizarEstadoReserva(reserva.id, 'completada')">
                ğŸ‰ Completar
              </button>
              <button *ngIf="reserva.estado === 'pendiente' || reserva.estado === 'confirmada'" 
                      class="btn-cancelar"
                      (click)="actualizarEstadoReserva(reserva.id, 'cancelada')">
                âŒ Cancelar
              </button>
            </div>
          </div>

          <div *ngIf="reservasFiltradas.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ“‹</div>
            <p>No hay reservaciones {{ filtroEstado ? 'con estado ' + filtroEstado : '' }}</p>
            <p class="empty-subtitle">Las reservas de tus paquetes aparecerÃ¡n aquÃ­</p>
          </div>
        </div>
      </div>

      <!-- ============ SECCIÃ“N PAQUETES ============ -->
      <!-- Lista de Paquetes -->
      <div class="paquetes-section" *ngIf="vistaActual === 'paquetes' && !mostrarFormulario">
        <div class="section-header">
          <h2>ğŸ“¦ Mis Paquetes de Viaje</h2>
          <button (click)="abrirFormulario()" class="btn-primary">
            â• Nuevo Paquete
          </button>
        </div>

        <!-- Filtros -->
        <div class="filtros">
          <input 
            type="text" 
            [(ngModel)]="busqueda" 
            placeholder="ğŸ” Buscar paquetes..."
            class="input-busqueda">
          
          <select [(ngModel)]="filtroDestino" class="select-filtro">
            <option [ngValue]="null">ğŸŒ Todos los destinos</option>
            <option *ngFor="let destino of destinosDisponibles" [ngValue]="destino.id">
              {{ destino.nombre }}, {{ destino.pais }}
            </option>
          </select>
        </div>

        <!-- Grid de Paquetes -->
        <div class="paquetes-grid">
          <div *ngFor="let paquete of paquetesFiltrados" class="paquete-card">
            <!-- Destinos -->
            <div class="destinos-badge">
              <span *ngFor="let destino of paquete.destinosCompletos" class="badge">
                ğŸ“ {{ destino.nombre }}
              </span>
            </div>

            <h3>{{ paquete.nombre }}</h3>
            <p class="precio">{{ paquete.precio | currency:'MXN':'symbol-narrow':'1.0-0' }}</p>
            <p class="duracion">â±ï¸ {{ paquete.duracion }}</p>
            
            <div class="incluye-preview">
              <strong>âœ¨ Incluye:</strong>
              <ul>
                <li *ngFor="let item of paquete.incluye.slice(0, 3)">{{ item }}</li>
                <li *ngIf="paquete.incluye.length > 3">
                  +{{ paquete.incluye.length - 3 }} mÃ¡s...
                </li>
              </ul>
            </div>

            <div *ngIf="paquete.itinerario.length > 0" class="itinerario-preview">
              <strong>ğŸ—“ï¸ Itinerario:</strong>
              <p>{{ paquete.itinerario.length }} dÃ­as planificados</p>
            </div>
            
            <div class="card-actions">
              <button (click)="editarPaquete(paquete)" class="btn-edit">
                âœï¸ Editar
              </button>
              <button (click)="eliminarPaquete(paquete.id)" class="btn-delete">
                ğŸ—‘ï¸ Eliminar
              </button>
            </div>
          </div>

          <div *ngIf="paquetesFiltrados.length === 0 && paquetes.length > 0" class="empty-state">
            <p>ğŸ” No se encontraron paquetes con esos filtros</p>
          </div>

          <div *ngIf="paquetes.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ“¦</div>
            <p>No tienes paquetes aÃºn</p>
            <p class="empty-subtitle">Crea tu primer paquete de viaje para empezar</p>
            <button (click)="abrirFormulario()" class="btn-primary">
              â• Crear Primer Paquete
            </button>
          </div>
        </div>
      </div>

      <!-- Formulario de Paquete -->
      <div class="form-container" *ngIf="mostrarFormulario">
        <div class="form-header">
          <h2>{{ editandoPaquete ? 'âœï¸ Editar Paquete' : 'â• Nuevo Paquete' }}</h2>
          <button (click)="cerrarFormulario()" class="btn-close">âœ•</button>
        </div>

        <form (ngSubmit)="guardarPaquete()" class="paquete-form">
          
          <!-- SECCIÃ“N: DESTINOS -->
          <div class="form-section destinos-section">
            <h3>ğŸŒ Destinos del Paquete *</h3>
            <p class="section-description">Selecciona los destinos que incluye este paquete</p>
            
            <div class="destinos-grid">
              <div 
                *ngFor="let destino of destinosDisponibles" 
                class="destino-item"
                [class.selected]="esDestinoSeleccionado(destino.id)"
                (click)="toggleDestino(destino.id)">
                <div class="destino-checkbox">
                  <input 
                    type="checkbox" 
                    [checked]="esDestinoSeleccionado(destino.id)"
                    (click)="$event.stopPropagation()">
                </div>
                <div class="destino-info">
                  <img *ngIf="destino.imagen_principal" 
                       [src]="destino.imagen_principal" 
                       [alt]="destino.nombre"
                       class="destino-imagen">
                  <div class="destino-nombre">{{ destino.nombre }}</div>
                  <div class="destino-pais">{{ destino.pais }}</div>
                </div>
              </div>
            </div>

            <div *ngIf="nuevoPaquete.destinos.length === 0" class="warning-message">
              âš ï¸ Debes seleccionar al menos un destino
            </div>

            <div *ngIf="nuevoPaquete.destinos.length > 0" class="selected-destinos">
              <strong>Destinos seleccionados:</strong>
              <span *ngFor="let destinoId of nuevoPaquete.destinos" class="badge-selected">
                {{ getNombreDestino(destinoId) }}
              </span>
            </div>
          </div>

          <!-- SECCIÃ“N: INFORMACIÃ“N BÃSICA -->
          <div class="form-section">
            <h3>ğŸ“‹ InformaciÃ³n BÃ¡sica</h3>
            
            <div class="form-group">
              <label>Nombre del Paquete *</label>
              <input 
                type="text" 
                [(ngModel)]="nuevoPaquete.nombre" 
                name="nombre"
                required
                placeholder="Ej: Tour Completo CancÃºn 5 dÃ­as">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Precio (MXN) *</label>
                <input 
                  type="number" 
                  [(ngModel)]="nuevoPaquete.precio" 
                  name="precio"
                  required
                  min="0"
                  placeholder="12000">
              </div>

              <div class="form-group">
                <label>DuraciÃ³n *</label>
                <input 
                  type="text" 
                  [(ngModel)]="nuevoPaquete.duracion" 
                  name="duracion"
                  required
                  placeholder="Ej: 5 dÃ­as / 4 noches">
              </div>
            </div>
          </div>

          <!-- SECCIÃ“N: QUÃ‰ INCLUYE -->
          <div class="form-section">
            <h3>âœ¨ Â¿QuÃ© Incluye?</h3>
            
            <div class="add-item">
              <input 
                type="text" 
                [(ngModel)]="nuevoIncluye" 
                name="incluye"
                placeholder="Ej: Hotel 5 estrellas todo incluido"
                (keyup.enter)="agregarIncluye()">
              <button type="button" (click)="agregarIncluye()" class="btn-add">
                + Agregar
              </button>
            </div>

            <ul class="items-list">
              <li *ngFor="let item of nuevoPaquete.incluye; let i = index">
                âœ“ {{ item }}
                <button type="button" (click)="eliminarIncluye(i)" class="btn-remove">
                  âœ•
                </button>
              </li>
            </ul>
          </div>

          <!-- SECCIÃ“N: ITINERARIO -->
          <div class="form-section">
            <h3>ğŸ—“ï¸ Itinerario Detallado</h3>
            
            <div class="add-item itinerario">
              <input 
                type="number" 
                [(ngModel)]="nuevoItinerario.dia" 
                name="dia"
                placeholder="DÃ­a"
                min="1"
                class="dia-input">
              <input 
                type="text" 
                [(ngModel)]="nuevoItinerario.actividades" 
                name="actividades"
                placeholder="Actividades del dÃ­a"
                (keyup.enter)="agregarItinerario()">
              <button type="button" (click)="agregarItinerario()" class="btn-add">
                + Agregar
              </button>
            </div>

            <div class="itinerario-list">
              <div *ngFor="let item of nuevoPaquete.itinerario; let i = index" class="itinerario-item">
                <div class="itinerario-dia">DÃ­a {{ item.dia }}</div>
                <div class="itinerario-actividades">{{ item.actividades }}</div>
                <button type="button" (click)="eliminarItinerario(i)" class="btn-remove">
                  âœ•
                </button>
              </div>
            </div>
          </div>

          <!-- SECCIÃ“N: GASTOS INCLUIDOS -->
          <div class="form-section">
            <h3>ğŸ’° Gastos Incluidos en el Paquete</h3>
            
            <div class="add-item gasto">
              <input 
                type="text" 
                [(ngModel)]="nuevoGasto.concepto" 
                name="concepto"
                placeholder="Concepto (Ej: Transporte aeropuerto)">
              <input 
                type="number" 
                [(ngModel)]="nuevoGasto.monto" 
                name="monto"
                placeholder="Monto"
                min="0"
                class="monto-input">
              <button type="button" (click)="agregarGasto()" class="btn-add">
                + Agregar
              </button>
            </div>

            <div class="gastos-list">
              <div *ngFor="let gasto of nuevoPaquete.gastos; let i = index" class="gasto-item">
                <span>{{ gasto.concepto }}</span>
                <span class="monto">{{ gasto.monto | currency:'MXN':'symbol-narrow':'1.0-0' }}</span>
                <button type="button" (click)="eliminarGasto(i)" class="btn-remove">
                  âœ•
                </button>
              </div>
              
              <div *ngIf="nuevoPaquete.gastos.length > 0" class="total">
                <strong>Total de Gastos Incluidos:</strong>
                <strong class="monto">{{ getTotalGastos() | currency:'MXN':'symbol-narrow':'1.0-0' }}</strong>
              </div>
            </div>
          </div>

          <!-- BOTONES DE ACCIÃ“N -->
          <div class="form-actions">
            <button type="button" (click)="cerrarFormulario()" class="btn-secondary">
              Cancelar
            </button>
            <button type="submit" class="btn-primary">
              {{ editandoPaquete ? 'ğŸ’¾ Actualizar' : 'âœ¨ Crear' }} Paquete
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>