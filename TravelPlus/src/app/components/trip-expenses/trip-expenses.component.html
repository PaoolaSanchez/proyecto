<div class="expenses-container">
  <!-- Header -->
  <header class="expenses-header">
    <button class="back-btn" (click)="volverAtras()">
      ‚Üê
    </button>
    <h1 class="expenses-title">{{ nombreViaje || 'Gastos del Viaje' }}</h1>
    <button class="add-btn" (click)="abrirModalGasto()">
      +
    </button>
  </header>

  <!-- Resumen Total -->
  <div class="summary-card">
    <div class="summary-item">
      <span class="summary-label">Total Gastos</span>
      <span class="summary-value total">{{ formatearMonto(getTotalGastos()) }}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">Por Persona</span>
      <span class="summary-value">{{ formatearMonto(getGastoPorPersona()) }}</span>
    </div>
  </div>

  <!-- Tabs de Navegaci√≥n -->
  <div class="tabs-container">
    <button class="tab-btn active" onclick="this.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); document.querySelector('.gastos-section').style.display='block'; document.querySelector('.balances-section').style.display='none';">
      Gastos
    </button>
    <button class="tab-btn" onclick="this.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); document.querySelector('.gastos-section').style.display='none'; document.querySelector('.balances-section').style.display='block';">
      Balances
    </button>
  </div>

  <!-- SECCI√ìN: Lista de Gastos -->
  <div class="gastos-section">
    <!-- Resumen por Categor√≠as -->
    <div class="categories-summary" *ngIf="categoriasResumen.length > 0">
      <h3 class="section-subtitle">Por Categor√≠a</h3>
      <div class="category-item" *ngFor="let cat of categoriasResumen">
        <div class="category-info">
          <span class="category-dot" [style.background-color]="cat.color"></span>
          <span class="category-name">{{ cat.nombre }}</span>
        </div>
        <span class="category-amount">{{ formatearMonto(cat.total) }}</span>
      </div>
    </div>

    <!-- Lista de Gastos -->
    <div class="expenses-list">
      <h3 class="section-subtitle">Todos los Gastos</h3>
      
      <div class="expense-item" 
           *ngFor="let gasto of gastos"
           [class.expense-agencia]="esGastoDeAgencia(gasto)">
        
        <div class="expense-header">
          <span *ngIf="esGastoDeAgencia(gasto)" class="badge-agencia">
            üìã Agencia
          </span>
          <span class="expense-category" [style.color]="getColorCategoria(gasto.categoria)">
            {{ gasto.categoria }}
          </span>
        </div>
        
        <div class="expense-content">
          <h4 class="expense-description">{{ gasto.descripcion.replace('[Agencia]', '') }}</h4>
          <p class="expense-details">
            Pagado por: <strong>{{ gasto.pagadoPor }}</strong><br>
            Dividir entre: {{ getParticipantesNombres(gasto.dividirEntre) }}<br>
            Fecha: {{ gasto.fecha }}
          </p>
        </div>
        
        <div class="expense-footer">
          <span class="expense-amount">{{ formatearMonto(gasto.monto) }}</span>
          <button *ngIf="!esGastoDeAgencia(gasto)" 
                  class="btn-delete"
                  (click)="eliminarGasto(gasto)">
            üóëÔ∏è
          </button>
        </div>
      </div>

      <div *ngIf="gastos.length === 0" class="empty-state">
        <p>üìù No hay gastos registrados a√∫n</p>
        <button class="btn-primary" (click)="abrirModalGasto()">
          Agregar Primer Gasto
        </button>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN: Balances por Participante -->
  <div class="balances-section" style="display: none;">
    <h3 class="section-subtitle">Balance por Participante</h3>
    
    <div class="balance-card" *ngFor="let participante of participantes">
      <div class="balance-header">
        <div class="participant-info">
          <div class="participant-avatar" [style.background-color]="participante.color">
            {{ participante.iniciales || participante.nombre.charAt(0) }}
          </div>
          <div>
            <h4 class="participant-name">{{ participante.nombre }}</h4>
            <p class="participant-email">{{ participante.email }}</p>
          </div>
        </div>
        <button class="btn-add-payment" (click)="abrirModalPago(participante)">
          + Registrar Pago
        </button>
      </div>

      <div class="balance-details">
        <div class="balance-row">
          <span class="balance-label">Total a Pagar:</span>
          <span class="balance-value debe">{{ formatearMonto(getBalancePorPersona(participante.email || participante.nombre).debe) }}</span>
        </div>
        <div class="balance-row">
          <span class="balance-label">Total Pagado:</span>
          <span class="balance-value pagado">{{ formatearMonto(getBalancePorPersona(participante.email || participante.nombre).pagado) }}</span>
        </div>
        <div class="balance-row balance-total">
          <span class="balance-label">Balance:</span>
          <span class="balance-value" 
                [class.positivo]="getBalancePorPersona(participante.email || participante.nombre).balance >= 0"
                [class.negativo]="getBalancePorPersona(participante.email || participante.nombre).balance < 0">
            {{ formatearMonto(abs(getBalancePorPersona(participante.email || participante.nombre).balance)) }}
            <span *ngIf="getBalancePorPersona(participante.email || participante.nombre).balance >= 0"> a favor</span>
            <span *ngIf="getBalancePorPersona(participante.email || participante.nombre).balance < 0"> pendiente</span>
          </span>
        </div>
      </div>

      <!-- Historial de Pagos -->
      <div class="payments-history" *ngIf="getPagosPorParticipante(participante.email || participante.nombre).length > 0">
        <h5 class="payments-title">Pagos Registrados:</h5>
        <div class="payment-item" *ngFor="let pago of getPagosPorParticipante(participante.email || participante.nombre)">
          <div class="payment-info">
            <span class="payment-description">{{ pago.descripcion }}</span>
            <span class="payment-date">{{ pago.fecha }}</span>
          </div>
          <div class="payment-actions">
            <span class="payment-amount">{{ formatearMonto(pago.monto) }}</span>
            <button class="btn-delete-small" (click)="eliminarPago(pago)">√ó</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Agregar Gasto -->
  <div class="modal-overlay" *ngIf="mostrarModalGasto" (click)="cerrarModalGasto()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Agregar Gasto</h2>
        <button class="modal-close" (click)="cerrarModalGasto()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Descripci√≥n</label>
          <input type="text" 
                 [(ngModel)]="descripcionGasto" 
                 placeholder="Ej: Cena en restaurante"
                 class="form-input">
        </div>

        <div class="form-group">
          <label>Monto</label>
          <input type="number" 
                 [(ngModel)]="montoGasto" 
                 placeholder="0.00"
                 class="form-input">
        </div>

        <div class="form-group">
          <label>Categor√≠a</label>
          <select [(ngModel)]="categoriaSeleccionada" class="form-select">
            <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>Dividir entre:</label>
          <div class="participants-selection">
            <div class="participant-chip" 
                 *ngFor="let p of participantes"
                 [class.selected]="p.seleccionado"
                 (click)="toggleParticipante(p)">
              <div class="chip-avatar" [style.background-color]="p.color">
                {{ p.iniciales || p.nombre.charAt(0) }}
              </div>
              <span class="chip-name">{{ p.nombre }}</span>
              <span class="chip-check" *ngIf="p.seleccionado">‚úì</span>
            </div>
          </div>
        </div>

        <button class="btn-submit" (click)="agregarGasto()">
          Agregar Gasto
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Registrar Pago -->
  <div class="modal-overlay" *ngIf="mostrarModalPago" (click)="cerrarModalPago()">
    <div class="modal-content modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Registrar Pago</h2>
        <button class="modal-close" (click)="cerrarModalPago()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="participant-selected" *ngIf="participanteSeleccionadoPago">
          <div class="participant-avatar" [style.background-color]="participanteSeleccionadoPago.color">
            {{ participanteSeleccionadoPago.iniciales || participanteSeleccionadoPago.nombre.charAt(0) }}
          </div>
          <div>
            <h4>{{ participanteSeleccionadoPago.nombre }}</h4>
            <p>{{ participanteSeleccionadoPago.email }}</p>
          </div>
        </div>

        <div class="form-group">
          <label>Monto Pagado</label>
          <input type="number" 
                 [(ngModel)]="montoPago" 
                 placeholder="0.00"
                 class="form-input"
                 autofocus>
        </div>

        <div class="form-group">
          <label>Descripci√≥n (opcional)</label>
          <input type="text" 
                 [(ngModel)]="descripcionPago" 
                 placeholder="Ej: Transferencia por hospedaje"
                 class="form-input">
        </div>

        <button class="btn-submit" (click)="agregarPago()">
          Registrar Pago
        </button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item" 
            (click)="cambiarTab('inicio')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </span>
      <span class="nav-label">Inicio</span>
    </button>
    
    <button class="nav-item" 
            (click)="cambiarTab('explorar')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </span>
      <span class="nav-label">Explorar</span>
    </button>
    
    <button class="nav-item active" 
            (click)="cambiarTab('viajes')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
        </svg>
      </span>
      <span class="nav-label">Viajes</span>
    </button>
    
    <button class="nav-item" 
            (click)="cambiarTab('favoritos')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
      </span>
      <span class="nav-label">Favoritos</span>
    </button>
    
    <button class="nav-item" 
            (click)="cambiarTab('perfil')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </span>
      <span class="nav-label">Perfil</span>
    </button>
  </nav>
</div>