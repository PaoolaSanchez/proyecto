<div class="detail-container" *ngIf="destinoActual">
  <!-- Auth Warning Modal -->
  <app-auth-warning-modal
    [isVisible]="mostrarAuthWarning"
    (close)="closeAuthWarning()"
    (login)="onAuthWarningLogin()"
    (signup)="onAuthWarningSignup()">
  </app-auth-warning-modal>

  <!-- Indicador de carga -->
  <div *ngIf="cargando" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando informaci√≥n del destino...</p>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="errorCarga" class="error-container">
    <p class="error-message">{{ errorCarga }}</p>
    <button class="btn-retry" (click)="volverAtras()">‚Üê Volver atr√°s</button>
  </div>

  <div *ngIf="!cargando && !errorCarga">
    <!-- Header -->
    <header class="detail-header">
      <button class="back-btn" (click)="volverAtras()">‚Üê</button>
      <h1 class="detail-title">{{ destinoActual.nombre }}</h1>
      <button class="share-btn" (click)="compartir()">‚§¥</button>
    </header>

    <!-- Imagen Principal -->
    <div class="main-image-container">
      <img [src]="destinoActual.imagenPrincipal" [alt]="destinoActual.nombre" class="main-image">
      <div class="image-overlay">
        <h2 class="destination-name">{{ destinoActual.nombre }}</h2>
        <p class="destination-country">üìç {{ destinoActual.pais }}</p>
      </div>
    </div>

    <!-- Galer√≠a de Im√°genes -->
    <div class="gallery-container">
      <div class="gallery-scroll">
        <img 
          *ngFor="let imagen of destinoActual.imagenesGaleria" 
          [src]="imagen" 
          [alt]="destinoActual.nombre"
          class="gallery-image">
      </div>
    </div>  <!-- Tabs Navigation -->
  <div class="tabs-navigation">
    <button 
      class="tab-btn" 
      [class.active]="tabActiva === 'informacion'"
      (click)="cambiarTab('informacion')">
      Informaci√≥n
    </button>
    <button 
      class="tab-btn" 
      [class.active]="tabActiva === 'consejos'"
      (click)="cambiarTab('consejos')">
      Consejos
    </button>
    <button 
      class="tab-btn" 
      [class.active]="tabActiva === 'agencias'"
      (click)="cambiarTab('agencias')">
      Agencias
    </button>
    <button 
      class="tab-btn" 
      [class.active]="tabActiva === 'contacto'"
      (click)="cambiarTab('contacto')">
      Contacto
    </button>
  </div>

  <!-- Contenido de las pesta√±as -->
  <div class="tab-content">
    <!-- Informaci√≥n -->
    <div *ngIf="tabActiva === 'informacion' && !mostrarDetalleAgencia && !mostrarDetallePaquete" class="tab-panel">
      <div class="info-section">
        <h3 class="section-title">Sobre {{ destinoActual.nombre }}</h3>
        <p class="section-description">{{ destinoActual.descripcion }}</p>
        
        <!-- Qu√© hacer -->
        <div class="subsection">
          <h4 class="subsection-title">‚ú® Qu√© hacer</h4>
          <ul class="activities-list">
            <li *ngFor="let actividad of destinoActual.queHacer" class="activity-item">
              {{ actividad }}
            </li>
          </ul>
        </div>

        <!-- Detalles del Viaje -->
        <div class="subsection">
          <h4 class="subsection-title">üìã Detalles del Viaje</h4>
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-icon">üå§Ô∏è</span>
              <div class="detail-info">
                <span class="detail-label">Mejor √©poca</span>
                <span class="detail-value">{{ destinoActual.detallesViaje.mejorEpoca }}</span>
              </div>
            </div>
            <div class="detail-item">
              <span class="detail-icon">‚è±Ô∏è</span>
              <div class="detail-info">
                <span class="detail-label">Duraci√≥n</span>
                <span class="detail-value">{{ destinoActual.detallesViaje.duracionRecomendada }}</span>
              </div>
            </div>
            <div class="detail-item">
              <span class="detail-icon">üí∞</span>
              <div class="detail-info">
                <span class="detail-label">Presupuesto</span>
                <span class="detail-value">{{ destinoActual.detallesViaje.presupuestoPromedio }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Qu√© llevar -->
        <div class="subsection">
          <h4 class="subsection-title">üéí Qu√© llevar</h4>
          <div class="items-grid">
            <span *ngFor="let item of destinoActual.queEllevar" class="item-badge">
              {{ item }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Consejos -->
    <div *ngIf="tabActiva === 'consejos' && !mostrarDetalleAgencia && !mostrarDetallePaquete" class="tab-panel">
      <div class="consejos-section">
        <h3 class="consejos-title">üí° Consejos de viaje</h3>
        <ul class="consejos-list">
          <li *ngFor="let consejo of destinoActual.consejos" class="consejo-item">
            <span class="consejo-icon">‚úì</span>
            {{ consejo }}
          </li>
        </ul>
      </div>
    </div>

    <!-- Agencias -->
    <div *ngIf="tabActiva === 'agencias' && !mostrarDetalleAgencia && !mostrarDetallePaquete" class="tab-panel">
      <div class="agencias-intro">
        <h3 class="agencias-title">üè¢ Agencias Especializadas</h3>
        <p class="agencias-subtitle">
          Descubre paquetes todo incluido para {{ destinoActual.nombre }} ofrecidos por agencias certificadas
        </p>
      </div>

      <!-- Lista de agencias -->
      <div class="agencias-preview">
        <div 
          class="agency-preview-card" 
          *ngFor="let agencia of getAgenciasParaDestino()"
          (click)="verDetalleAgencia(agencia)">
          <div class="agency-preview-logo">{{ agencia.logo }}</div>
          <div class="agency-preview-info">
            <h4 class="agency-preview-name">{{ agencia.nombre }}</h4>
            <p class="agency-preview-description">{{ agencia.descripcion }}</p>
            <div class="agency-preview-meta">
              <span class="preview-rating" *ngIf="agencia.rating">
                ‚≠ê {{ agencia.rating.toFixed(1) }}
              </span>
              <span class="preview-packages">
                {{ contarPaquetes(agencia.id) }} paquetes disponibles
              </span>
            </div>
          </div>
          <span class="arrow-icon">‚Ä∫</span>
        </div>

        <!-- Cargando paquetes -->
        <div *ngIf="cargandoPaquetes" class="loading-packages">
          <div class="spinner-small"></div>
          <p>Cargando paquetes disponibles...</p>
        </div>

        <!-- Sin agencias -->
        <div *ngIf="!cargandoPaquetes && getAgenciasParaDestino().length === 0" class="no-agencies">
          <div class="no-agencies-icon">üè¢</div>
          <p class="no-agencies-text">
            A√∫n no hay paquetes disponibles para este destino
          </p>
        </div>
      </div>
    </div>

    <!-- Vista Detalle Agencia -->
    <div *ngIf="mostrarDetalleAgencia && agenciaSeleccionada && !mostrarDetallePaquete" class="tab-panel">
      <button class="btn-back-inline" (click)="cerrarDetalleAgencia()">
        ‚Üê Volver a agencias
      </button>

      <div class="agency-detail-card">
        <div class="agency-detail-header">
          <div class="agency-logo-large">{{ agenciaSeleccionada.logo }}</div>
          <div class="agency-detail-info">
            <h2 class="agency-detail-name">{{ agenciaSeleccionada.nombre }}</h2>
            <p class="agency-detail-description">{{ agenciaSeleccionada.descripcion }}</p>
            <div class="agency-detail-rating" *ngIf="agenciaSeleccionada.rating">
              <span *ngFor="let estrella of getEstrellas(agenciaSeleccionada.rating || 4.5)" class="star">
                {{ estrella }}
              </span>
              <span class="rating-number">{{ agenciaSeleccionada.rating.toFixed(1) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Paquetes de la agencia -->
      <section class="packages-section">
        <h3 class="section-title">üì¶ Paquetes Disponibles</h3>
        
        <div class="packages-list">
          <div 
            *ngFor="let paquete of getPaquetesPorAgencia(agenciaSeleccionada.id)"
            class="package-card"
            (click)="verDetallePaquete(paquete)">
            <div class="package-header">
              <h4 class="package-name">{{ paquete.nombre }}</h4>
              <span class="package-price">${{ paquete.precio.toLocaleString() }}</span>
            </div>
            <p class="package-duration">‚è±Ô∏è {{ paquete.duracion }}</p>
            <div class="package-includes">
              <span class="include-badge" *ngFor="let item of paquete.incluye.slice(0, 3)">
                ‚úì {{ item }}
              </span>
              <span class="more-includes" *ngIf="paquete.incluye.length > 3">
                +{{ paquete.incluye.length - 3 }} m√°s
              </span>
            </div>
          </div>
        </div>

        <!-- Sin paquetes -->
        <div *ngIf="getPaquetesPorAgencia(agenciaSeleccionada.id).length === 0" class="no-packages">
          <p>No hay paquetes disponibles para este destino</p>
        </div>
      </section>
    </div>

    <!-- Vista Detalle Paquete -->
    <div *ngIf="mostrarDetallePaquete && paqueteSeleccionado" class="tab-panel">
      <button class="btn-back-inline" (click)="volverAAgencia()">
        ‚Üê Volver a {{ agenciaSeleccionada?.nombre }}
      </button>

      <div class="package-detail-card">
        <h2 class="package-detail-name">{{ paqueteSeleccionado.nombre }}</h2>
        <div class="package-detail-meta">
          <span class="detail-duration">‚è±Ô∏è {{ paqueteSeleccionado.duracion }}</span>
          <span class="detail-price">${{ paqueteSeleccionado.precio.toLocaleString() }} MXN</span>
        </div>
      </div>

      <!-- Incluye -->
      <section class="detail-section">
        <h3 class="detail-section-title">‚úì Incluye</h3>
        <ul class="includes-list">
          <li *ngFor="let item of paqueteSeleccionado.incluye" class="include-item">
            {{ item }}
          </li>
        </ul>
      </section>

      <!-- Itinerario -->
      <section class="detail-section">
        <h3 class="detail-section-title">üìÖ Itinerario</h3>
        <div class="itinerary-list">
          <div *ngFor="let item of paqueteSeleccionado.itinerario" class="itinerary-item">
            <div class="itinerary-day">D√≠a {{ item.dia }}</div>
            <div class="itinerary-content">
              <p class="itinerary-activity">{{ item.actividades }}</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Desglose de Gastos -->
      <section class="detail-section">
        <h3 class="detail-section-title">üí∞ Desglose de Gastos</h3>
        <div class="expenses-list">
          <div *ngFor="let gasto of paqueteSeleccionado.gastos" class="expense-item">
            <span class="expense-icon">üíµ</span>
            <span class="expense-concept">{{ gasto.concepto }}</span>
            <span class="expense-amount">${{ gasto.monto.toLocaleString() }}</span>
          </div>
          <div class="expense-total">
            <span class="total-label">Total</span>
            <span class="total-amount">${{ getTotalGastos(paqueteSeleccionado.gastos).toLocaleString() }} MXN</span>
          </div>
        </div>
      </section>

      <!-- Formulario de Reserva -->
      <section class="detail-section">
        <h3 class="detail-section-title">üìù Reservar Este Paquete</h3>
        
        <div class="reservation-form">
          <div class="form-group">
            <label class="form-label">Nombre completo</label>
            <input 
              type="text" 
              class="form-input"
              [(ngModel)]="nombreCliente"
              placeholder="Tu nombre completo">
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input 
              type="email" 
              class="form-input"
              [(ngModel)]="emailCliente"
              placeholder="tu@email.com">
          </div>

          <div class="form-group">
            <label class="form-label">Tel√©fono</label>
            <input 
              type="tel" 
              class="form-input"
              [(ngModel)]="telefonoCliente"
              placeholder="(555) 123-4567">
          </div>

          <div class="form-group">
            <label class="form-label">Fecha de salida</label>
            <input 
              type="date" 
              class="form-input"
              [(ngModel)]="fechaSalida">
          </div>

          <div class="form-group">
            <label class="form-label">N√∫mero de personas</label>
            <input 
              type="number" 
              class="form-input"
              [(ngModel)]="numPersonas"
              min="1"
              max="10">
          </div>

          <!-- Resumen de precio -->
          <div class="precio-resumen">
            <div class="precio-linea">
              <span>Precio por persona:</span>
              <span>${{ paqueteSeleccionado.precio.toLocaleString() }} MXN</span>
            </div>
            <div class="precio-linea" *ngIf="numPersonas > 1">
              <span>N√∫mero de personas:</span>
              <span>√ó {{ numPersonas }}</span>
            </div>
            <div class="precio-total-final">
              <span>Total a pagar:</span>
              <span class="precio-grande">${{ (paqueteSeleccionado.precio * numPersonas).toLocaleString() }} MXN</span>
            </div>
          </div>

          <button class="btn-reserve" (click)="reservarPaquete()">
            Confirmar Reserva
          </button>

          <p class="reservation-note">
            üí° Al reservar, este viaje se agregar√° autom√°ticamente a tu secci√≥n de "Mis Viajes" con todos los detalles incluidos.
          </p>
        </div>
      </section>
    </div>

    <!-- Contacto -->
    <div *ngIf="tabActiva === 'contacto' && !mostrarDetalleAgencia && !mostrarDetallePaquete" class="tab-panel">
      <div class="contacto-section">
        <h3 class="contacto-title">üìû Informaci√≥n de contacto</h3>
        
        <!-- Emergencias -->
        <div class="emergencias-box">
          <h4 class="emergencias-title">üö® N√∫meros de Emergencia</h4>
          <div class="emergencia-item">
            <span class="emergencia-label">Polic√≠a:</span>
            <span class="emergencia-valor">{{ destinoActual.emergencias.policia }}</span>
          </div>
          <div class="emergencia-item">
            <span class="emergencia-label">Bomberos:</span>
            <span class="emergencia-valor">{{ destinoActual.emergencias.bomberos }}</span>
          </div>
          <div class="emergencia-item">
            <span class="emergencia-label">Ambulancia:</span>
            <span class="emergencia-valor">{{ destinoActual.emergencias.ambulancia }}</span>
          </div>
          <div class="emergencia-item">
            <span class="emergencia-label">Embajada:</span>
            <span class="emergencia-valor">{{ destinoActual.emergencias.embajada }}</span>
          </div>
        </div>

        <!-- Informaci√≥n Tur√≠stica -->
        <div class="contacto-info">
          <h4 class="contacto-subtitle">‚ÑπÔ∏è Informaci√≥n Tur√≠stica</h4>
          <div class="contacto-item">
            <span class="contacto-icon">üìß</span>
            <span class="contacto-text">info@{{ destinoActual.nombre.toLowerCase() }}.com</span>
          </div>
          <div class="contacto-item">
            <span class="contacto-icon">üìû</span>
            <span class="contacto-text">+1 800 123 4567</span>
          </div>
          <div class="contacto-item">
            <span class="contacto-icon">üåê</span>
            <span class="contacto-text">www.{{ destinoActual.nombre.toLowerCase() }}.travel</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons (solo en informaci√≥n y consejos) -->
  <div class="action-buttons" *ngIf="(tabActiva === 'informacion' || tabActiva === 'consejos') && !mostrarDetalleAgencia && !mostrarDetallePaquete">
    <button class="action-btn primary" (click)="abrirColecciones()">
      <span class="btn-icon">üìå</span>
      Agregar a Viaje
    </button>
    <button class="action-btn secondary" (click)="guardar()">
      <span class="btn-icon">‚ù§Ô∏è</span>
      Guardar
    </button>
    <button class="action-btn secondary" (click)="abrirMapa()">
      <span class="btn-icon">üó∫Ô∏è</span>
      Ver Mapa
    </button>
  </div>

  <!-- Barra de Navegaci√≥n Inferior -->
  <nav class="bottom-nav">
    <button class="nav-item" (click)="cambiarTabPrincipal('inicio')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </span>
      <span class="nav-label">Inicio</span>
    </button>
    <button class="nav-item" (click)="cambiarTabPrincipal('explorar')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </span>
      <span class="nav-label">Explorar</span>
    </button>
    <button class="nav-item" (click)="cambiarTabPrincipal('viajes')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
        </svg>
      </span>
      <span class="nav-label">Viajes</span>
    </button>
    <button class="nav-item" (click)="cambiarTabPrincipal('favoritos')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
      </span>
      <span class="nav-label">Favoritos</span>
    </button>
    <button class="nav-item" (click)="cambiarTabPrincipal('perfil')">
      <span class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </span>
      <span class="nav-label">Perfil</span>
    </button>
  </nav>
</div>

<!-- Modal de Colecciones -->
<app-collections-modal
  *ngIf="mostrarColecciones && destinoActual"
  [destinoId]="destinoActual.id"
  (cerrar)="cerrarColecciones()"
  (destinoAgregado)="onDestinoAgregado($event)">
</app-collections-modal>

<!-- Modal Reserva Exitosa -->
<div class="modal-overlay" *ngIf="mostrarModalReservaExitosa">
  <div class="modal-content modal-success">
    <div class="modal-icon">‚úàÔ∏è</div>
    <h3>¬°Viaje Reservado!</h3>
    <p>Tu reservaci√≥n ha sido confirmada exitosamente.</p>
    <p class="email-confirmacion">Recibir√°s un correo de confirmaci√≥n a:<br><strong>{{ emailConfirmacion }}</strong></p>
    <div class="modal-actions">
      <button class="btn-modal-success" (click)="cerrarModalReservaExitosa()">Ver mis viajes</button>
    </div>
  </div>
</div>

<!-- Modal Reserva Error -->
<div class="modal-overlay" *ngIf="mostrarModalErrorReserva">
  <div class="modal-content modal-error">
    <div class="modal-icon">‚ùå</div>
    <h3>Error en la Reservaci√≥n</h3>
    <p>No se pudo completar tu reservaci√≥n. Por favor intenta nuevamente.</p>
    <div class="modal-actions">
      <button class="btn-modal-error" (click)="cerrarModalErrorReserva()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal del Mapa con Leaflet -->
<div class="modal-overlay modal-mapa-overlay" *ngIf="mostrarModalMapa" (click)="cerrarModalMapa()">
  <div class="modal-mapa-container" (click)="$event.stopPropagation()">
    <div class="modal-mapa-header">
      <div class="modal-mapa-info">
        <h3 class="modal-mapa-titulo">üìç {{ destinoActual.nombre }}</h3>
        <p class="modal-mapa-subtitulo">{{ destinoActual.pais }}</p>
      </div>
      <button class="btn-cerrar-mapa" (click)="cerrarModalMapa()">‚úï</button>
    </div>
    
    <div id="mapa-destino" class="mapa-leaflet-container"></div>
    
    <div class="modal-mapa-actions">
      <button class="btn-abrir-externo" (click)="abrirEnGoogleMaps()">
        <span>üó∫Ô∏è</span> Abrir en Google Maps
      </button>
    </div>
  </div>
</div>