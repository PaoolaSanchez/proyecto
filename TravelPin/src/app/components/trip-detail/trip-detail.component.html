<div class="trip-detail-container" *ngIf="viaje">
  
  <!-- Vista Principal del Detalle del Viaje -->
  <div *ngIf="!mostrarGastos && !mostrarMapa">
    <!-- Header -->
    <header class="trip-detail-header">
      <button class="back-btn" (click)="volverAtras()">
        â†
      </button>
      <h1 class="trip-detail-title">{{ viaje.nombre }}</h1>
      <button class="share-btn" (click)="compartir()" *ngIf="esViajeActivo()">
        â†—
      </button>
    </header>

    <!-- Fechas del Viaje -->
    <div class="trip-dates" *ngIf="viaje && viaje.fechaInicio && viaje.fechaFin">
      <div class="date-item">
        <span class="date-icon">ğŸ“…</span>
        <div class="date-info">
          <span class="date-label">Inicio</span>
          <span class="date-value">{{ viaje.fechaInicio }}</span>
        </div>
      </div>
      <div class="date-divider">â†’</div>
      <div class="date-item">
        <span class="date-icon">ğŸ“…</span>
        <div class="date-info">
          <span class="date-label">Fin</span>
          <span class="date-value">{{ viaje.fechaFin }}</span>
        </div>
      </div>
    </div>

    <!-- Banner de Viaje Finalizado -->
    <div *ngIf="!esViajeActivo()" class="banner-finalizado">
      <div class="banner-content">
        <h3 class="banner-title">Este viaje ha finalizado</h3>
        <p class="banner-subtitle">Â¡Califica tu experiencia en los destinos que visitaste!</p>
        <button 
          *ngIf="!viajeCalificado"
          class="btn-calificar" 
          (click)="abrirModalCalificacion()">
          Calificar Destino
        </button>
        <div *ngIf="viajeCalificado" class="calificacion-guardada">
          <div class="estrellas-guardadas">
            <span 
              *ngFor="let estrella of getEstrellas()" 
              class="estrella"
              [class.active]="estrella <= calificacionSeleccionada">
              â˜…
            </span>
          </div>
          <p class="resena-guardada" *ngIf="resenaViaje && resenaViaje.length > 0">{{ resenaViaje }}</p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="trip-detail-content">
      <!-- Action Buttons - Solo si estÃ¡ activo -->
      <div class="action-buttons" *ngIf="esViajeActivo()">
        <button class="action-btn primary" (click)="verGastos()">
          <span class="action-icon">ğŸ’°</span>
          <span class="action-text">Ver Gastos</span>
        </button>
        <button class="action-btn secondary" (click)="verMapa()">
          <span class="action-icon">ğŸ“</span>
          <span class="action-text">Ver Mapa</span>
        </button>
      </div>

      <!-- BotÃ³n Finalizar Viaje -->
      <div *ngIf="esViajeActivo()" class="finalizar-viaje-section">
        <button class="btn-finalizar-viaje" (click)="finalizarViaje()">
          Marcar viaje como finalizado
        </button>
      </div>

      <!-- Participantes Section -->
      <section class="detail-section">
        <div class="section-header">
          <h2 class="section-title">Participantes ({{ getContadorParticipantes() }})</h2>
          <span *ngIf="!esViajeActivo()" class="badge-readonly">Solo lectura</span>
        </div>

        <div class="participantes-list">
          <div 
            *ngFor="let participante of viaje.participantes"
            class="participante-item">
            <div class="participante-avatar" [style.background-color]="participante.color">
              {{ participante.iniciales }}
            </div>
            <span class="participante-nombre">{{ participante.nombre }}</span>
            <!-- BotÃ³n eliminar solo si el viaje estÃ¡ activo -->
            <button 
              class="btn-delete-mini" 
              (click)="eliminarParticipante(participante)"
              *ngIf="esViajeActivo() && viaje.participantes.length > 1">
              âœ•
            </button>
          </div>
        </div>

        <!-- Agregar Amigo - Solo si estÃ¡ activo -->
        <div class="add-friend-section" *ngIf="esViajeActivo()">
          <div *ngIf="!mostrarAgregarAmigo" class="email-input-container">
            <input 
              type="text" 
              class="email-input" 
              placeholder="Nombre de un amigo"
              readonly
              (click)="mostrarFormularioAmigo()">
            <button class="btn-add-friend" (click)="mostrarFormularioAmigo()">
              â¤
            </button>
          </div>

          <div *ngIf="mostrarAgregarAmigo" class="add-friend-form">
            <input 
              type="text" 
              class="friend-name-input" 
              placeholder="Nombre del amigo"
              [(ngModel)]="nuevoAmigo"
              (keyup.enter)="agregarAmigo()"
              autofocus>
            <div class="form-actions-inline">
              <button class="btn-cancel-inline" (click)="cancelarAgregarAmigo()">
                Cancelar
              </button>
              <button 
                class="btn-add-inline" 
                (click)="agregarAmigo()"
                [disabled]="!nuevoAmigo.trim()">
                Agregar
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Itinerario Section -->
      <section class="detail-section">
        <div class="section-header">
          <h2 class="section-title">Itinerario ({{ getContadorItinerario() }})</h2>
          <span *ngIf="!esViajeActivo()" class="badge-readonly">Solo lectura</span>
        </div>

        <div *ngIf="viaje.itinerario.length === 0" class="empty-message">
          No hay destinos en el itinerario
        </div>

        <div class="itinerario-list">
          <div 
            *ngFor="let destino of viaje.itinerario"
            class="itinerario-item"
            [class.readonly]="!esViajeActivo()"
            (click)="esViajeActivo() && verDestinoEnItinerario(destino)">
            <img [src]="destino.imagen" [alt]="destino.nombre" class="itinerario-image">
            <div class="itinerario-info">
              <h3 class="itinerario-nombre">{{ destino.nombre }}</h3>
              <p class="itinerario-pais">{{ destino.pais }}</p>
            </div>
            <!-- BotÃ³n eliminar solo si estÃ¡ activo -->
            <button 
              *ngIf="esViajeActivo()"
              class="btn-delete-itinerario" 
              (click)="eliminarDestinoItinerario(destino); $event.stopPropagation()">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      </section>

      <!-- Recordatorios Section -->
      <section class="detail-section recordatorios-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="bell-icon">ğŸ””</span>
            Recordatorios del Viaje
          </h2>
          <span *ngIf="!esViajeActivo()" class="badge-readonly">Solo lectura</span>
        </div>

        <!-- Lista de Recordatorios -->
        <div class="recordatorios-cards">
          <div 
            *ngFor="let recordatorio of viaje.recordatorios"
            class="recordatorio-card"
            [class.completed]="recordatorio.completado"
            [class.readonly]="!esViajeActivo()">
            <div class="recordatorio-left">
              <!-- BotÃ³n check solo funciona si estÃ¡ activo -->
              <button 
                class="btn-check-reminder"
                (click)="esViajeActivo() && toggleRecordatorio(recordatorio)"
                [class.checked]="recordatorio.completado"
                [disabled]="!esViajeActivo()">
                <span *ngIf="recordatorio.completado">âœ“</span>
              </button>
              <div class="recordatorio-text">
                <h3 class="recordatorio-name">{{ recordatorio.titulo }}</h3>
                <p class="recordatorio-time">Vence: {{ recordatorio.fecha }}</p>
              </div>
            </div>
            <div class="recordatorio-right">
              <!-- BotÃ³n eliminar solo si estÃ¡ activo -->
              <button 
                *ngIf="esViajeActivo()"
                class="btn-delete-reminder-icon"
                (click)="eliminarRecordatorio(recordatorio)">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        </div>

        <!-- Formulario Agregar Recordatorio - Solo si estÃ¡ activo -->
        <div class="add-recordatorio-form" *ngIf="mostrarFormularioRecordatorio && esViajeActivo()">
          <input 
            type="text" 
            class="recordatorio-input"
            placeholder="Nuevo Recordatorio"
            [(ngModel)]="nuevoRecordatorioTitulo"
            (keyup.enter)="agregarRecordatorio()">
          
          <div class="recordatorio-actions">
            <div class="date-input-wrapper">
              <input 
                type="date" 
                class="recordatorio-date-input"
                placeholder="dd/mm/aaaa"
                [(ngModel)]="nuevoRecordatorioFecha">
              <span class="calendar-icon">ğŸ“…</span>
            </div>
            <button class="btn-add-recordatorio" (click)="agregarRecordatorio()">
              AÃ±adir
            </button>
          </div>
        </div>

        <!-- BotÃ³n para mostrar formulario - Solo si estÃ¡ activo -->
        <button 
          *ngIf="!mostrarFormularioRecordatorio && esViajeActivo()"
          class="btn-show-form-recordatorio" 
          (click)="mostrarFormularioNuevoRecordatorio()">
          <span class="plus-icon">+</span>
          <span>AÃ±adir Recordatorio</span>
        </button>

        <!-- BotÃ³n cancelar si el formulario estÃ¡ visible -->
        <button 
          *ngIf="mostrarFormularioRecordatorio && esViajeActivo()"
          class="btn-cancel-recordatorio" 
          (click)="cancelarRecordatorio()">
          Cancelar
        </button>

        <!-- Mensaje si el viaje estÃ¡ finalizado y no hay recordatorios -->
        <div *ngIf="!esViajeActivo() && viaje.recordatorios.length === 0" class="empty-message-readonly">
          <span class="icon-empty">ğŸ“</span>
          <p>No hay recordatorios registrados para este viaje</p>
        </div>
      </section>
    </main>  

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <button class="nav-item">
        <span class="nav-icon">ğŸ </span>
        <span class="nav-label">Inicio</span>
      </button>
      <button class="nav-item">
        <span class="nav-icon">ğŸ”</span>
        <span class="nav-label">Explorar</span>
      </button>
      <button class="nav-item active">
        <span class="nav-icon">ğŸ§³</span>
        <span class="nav-label">Viajes</span>
      </button>
      <button class="nav-item">
        <span class="nav-icon">ğŸ’–</span>
        <span class="nav-label">Favoritos</span>
      </button>
      <button class="nav-item">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-label">Perfil</span>
      </button>
    </nav>
  </div>  

  <!-- Modal de CalificaciÃ³n -->
  <div class="modal-overlay" *ngIf="mostrarModalCalificacion" (click)="cerrarModalCalificacion()">
    <div class="modal-calificacion" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Calificar Destino</h2>
        <button class="btn-close-modal" (click)="cerrarModalCalificacion()">âœ•</button>
      </div>

      <div class="modal-body">
        <p class="modal-question">Â¿QuÃ© te pareciÃ³ tu viaje?</p>
        
        <div class="rating-stars">
          <button 
            *ngFor="let estrella of getEstrellas()"
            class="star-btn"
            [class.selected]="estrella <= calificacionSeleccionada"
            (click)="seleccionarCalificacion(estrella)">
            â˜…
          </button>
        </div>

        <div class="form-group">
          <label class="form-label">Escribe tu reseÃ±a aquÃ­...(opcional)</label>
          <textarea 
            class="form-textarea"
            [(ngModel)]="resenaViaje"
            placeholder="Comparte tu experiencia..."
            rows="4"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-guardar-calificacion" (click)="guardarCalificacion()">
          Guardar CalificaciÃ³n
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Compartir Viaje -->
  <div class="modal-overlay" *ngIf="mostrarModalCompartir" (click)="cerrarModalCompartir()">
    <div class="modal-compartir" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Invitar Amigos</h2>
        <button class="btn-close-modal" (click)="cerrarModalCompartir()">âœ•</button>
      </div>

      <div class="modal-body">
        <p class="modal-subtitle">Comparte este enlace para que tus amigos se unan al viaje</p>
        
        <!-- Enlace de invitaciÃ³n -->
        <div class="link-container">
          <input 
            type="text" 
            class="link-input" 
            [value]="enlaceInvitacion" 
            readonly>
          <button class="btn-copy-link" (click)="copiarEnlace()">
            ğŸ“‹ Copiar
          </button>
        </div>

        <!-- Compartir por email -->
        <div class="email-share-section">
          <h3 class="section-subtitle">Enviar por correo</h3>
          <div class="email-input-group">
            <input 
              type="email" 
              class="email-share-input"
              placeholder="correo@ejemplo.com"
              [(ngModel)]="emailInvitacion">
            <button class="btn-send-email" (click)="compartirPorEmail()">
              âœ‰ï¸ Enviar
            </button>
          </div>
        </div>

        <!-- Compartir por redes sociales -->
        <div class="social-share-section">
          <h3 class="section-subtitle">Compartir en</h3>
          <div class="social-buttons">
            <button class="btn-social whatsapp" (click)="compartirPorWhatsApp()">
              <span class="social-icon">ğŸ’¬</span>
              <span>WhatsApp</span>
            </button>
            <button class="btn-social general" (click)="compartirPorRedes()">
              <span class="social-icon">ğŸ“¤</span>
              <span>MÃ¡s</span>
            </button>
          </div>
        </div>

        <!-- InformaciÃ³n adicional -->
        <div class="info-box-share">
          <p class="info-text-share">
            ğŸ’¡ <strong>Tip:</strong> Las personas que reciban este enlace podrÃ¡n ver y editar el viaje.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista de Gastos -->
  <app-trip-expenses
    *ngIf="mostrarGastos"
    [viajeId]="viajeId"
    [nombreViaje]="viaje.nombre"
    [participantes]="viaje.participantes"
    (volver)="volverDeGastos()">
  </app-trip-expenses>

  <!-- Vista de Mapa -->
  <app-trip-map
    *ngIf="mostrarMapa"
    [nombreViaje]="viaje.nombre"
    [destinos]="viaje.itinerario"
    (volver)="volverDeMapa()">
  </app-trip-map>

</div>